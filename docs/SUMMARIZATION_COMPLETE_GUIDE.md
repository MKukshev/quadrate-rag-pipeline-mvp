# –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –≤ RAG-–ø–∞–π–ø–ª–∞–π–Ω–µ

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ü–∞—Ç—Ç–µ—Ä–Ω 1: –ü—Ä—è–º–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è](#–ø–∞—Ç—Ç–µ—Ä–Ω-1-–ø—Ä—è–º–∞—è-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è)
3. [–ü–∞—Ç—Ç–µ—Ä–Ω 2: Smart Context Compression](#–ø–∞—Ç—Ç–µ—Ä–Ω-2-smart-context-compression)
4. [–ü–∞—Ç—Ç–µ—Ä–Ω 3: –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã](#–ø–∞—Ç—Ç–µ—Ä–Ω-3-—Ä–µ–∂–∏–º—ã-—Ä–∞–±–æ—Ç—ã)
5. [–ü–∞—Ç—Ç–µ—Ä–Ω 4: –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ summaries](#–ø–∞—Ç—Ç–µ—Ä–Ω-4-–ø—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ-summaries)
6. [–ü–∞—Ç—Ç–µ—Ä–Ω 5: –ü–æ—Ç–æ–∫–æ–≤–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è](#–ø–∞—Ç—Ç–µ—Ä–Ω-5-–ø–æ—Ç–æ–∫–æ–≤–∞—è-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è)
7. [–ü–∞—Ç—Ç–µ—Ä–Ω 6: –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–¥–æ–≤](#–ø–∞—Ç—Ç–µ—Ä–Ω-6-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è-—Ç—Ä–µ–¥–æ–≤)
8. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
9. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-–∏-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)

---

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

### –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –≤ RAG?

**–ü—Ä–æ–±–ª–µ–º—ã –±–µ–∑ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏:**
- –ë–æ–ª—å—à–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ —É–º–µ—â–∞—é—Ç—Å—è –≤ context window LLM
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –≤–º–µ—Å—Ç–æ —Ü–µ–ª–æ—Å—Ç–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ summary

**–†–µ—à–µ–Ω–∏—è:**
1. **Map-Reduce** –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è** —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –ø–æ–¥ –º–æ–¥–µ–ª—å LLM
3. **–†–µ–∂–∏–º—ã** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö use cases
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
5. **Streaming** –¥–ª—è UX
6. **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è** –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ–¥–æ–≤

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
backend/services/
‚îú‚îÄ‚îÄ summarization.py           # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (Patterns 1, 2, 5)
‚îú‚îÄ‚îÄ llm_config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π (Pattern 2)
‚îú‚îÄ‚îÄ summary_store.py          # –•—Ä–∞–Ω–µ–Ω–∏–µ summaries (Pattern 4)
‚îú‚îÄ‚îÄ thread_parser.py          # –ü–∞—Ä—Å–∏–Ω–≥ —Ç—Ä–µ–¥–æ–≤ (Pattern 6)
‚îú‚îÄ‚îÄ thread_store.py           # –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–¥–æ–≤ (Pattern 6)
‚îî‚îÄ‚îÄ thread_summarization.py   # –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–¥–æ–≤ (Pattern 6)

Qdrant Collections:
‚îú‚îÄ‚îÄ rag_embeddings           # –û—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ document_summaries       # Pre-computed summaries (Pattern 4)
‚îú‚îÄ‚îÄ chat_messages           # –°–æ–æ–±—â–µ–Ω–∏—è —Ç—Ä–µ–¥–æ–≤ (Pattern 6)
‚îî‚îÄ‚îÄ thread_summaries        # Summaries —Ç—Ä–µ–¥–æ–≤ (Pattern 6)
```

---

## –ü–∞—Ç—Ç–µ—Ä–Ω 1: –ü—Ä—è–º–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è

### –û–ø–∏—Å–∞–Ω–∏–µ

–ë–∞–∑–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω - –ø—Ä—è–º–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Map-Reduce –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

### API

```bash
POST /summarize
{
  "doc_id": "document_123",
  "space_id": "demo",
  "focus": "Budget and timeline" # optional
}
```

### –ê–ª–≥–æ—Ä–∏—Ç–º

```python
if document_tokens <= 8000:
    # –ü—Ä–æ—Å—Ç–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –æ–¥–Ω–∏–º –≤—ã–∑–æ–≤–æ–º LLM
    summary = call_llm(document_text)
else:
    # Map-Reduce –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    # MAP —Ñ–∞–∑–∞: —Ä–∞–∑–±–∏—Ç—å –Ω–∞ —á–∞–Ω–∫–∏ –∏ —Å—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π
    chunk_summaries = []
    for chunk in split_document(6000 tokens):
        chunk_summary = call_llm(chunk)
        chunk_summaries.append(chunk_summary)
    
    # REDUCE —Ñ–∞–∑–∞: –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å summaries
    final_summary = call_llm(combine(chunk_summaries))
```

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **Map-Reduce** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ > 8K —Ç–æ–∫–µ–Ω–æ–≤
- **Focus parameter** –¥–ª—è —Ü–µ–ª–µ–≤–æ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
- **–¢–æ–∫–µ–Ω –ø–æ–¥—Å—á—ë—Ç** –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- **Error handling** —Å fallback

### Response

```json
{
  "doc_id": "document_123",
  "space_id": "demo",
  "summary": "This document discusses...",
  "chunks_processed": 25,
  "focus": "Budget and timeline",
  "cached": false
}
```

### Use Cases

- –ü–æ–ª—É—á–∏—Ç—å –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ü–æ–Ω—è—Ç—å —Å—É—Ç—å –±–µ–∑ —á—Ç–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
- –ò–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∞—Å–ø–µ–∫—Ç—É (focus)

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞  
‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–µ—Ç–∞–ª–∏ —á–µ—Ä–µ–∑ Map-Reduce  
‚úÖ –§–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è  
‚úÖ –ü—Ä–æ—Å—Ç–æ–π API

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–æ (5-20 —Å–µ–∫—É–Ω–¥)  
‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –∑–∞–Ω–æ–≤–æ  
‚ö†Ô∏è –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –ü–∞—Ç—Ç–µ—Ä–Ω 2: Smart Context Compression

### –û–ø–∏—Å–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ `/ask` –∫–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –ø—Ä–µ–≤—ã—à–∞—é—Ç `context window` –º–æ–¥–µ–ª–∏. –ü–æ—Ä–æ–≥–∏ –∞–¥–∞–ø—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ–¥ –∫–∞–∂–¥—É—é LLM.

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π

**–§–∞–π–ª:** `config/llm_models.json`

```json
{
  "model_name": "llama3.1:8b",
  "context_window": 8192,
  "max_output_tokens": 512,
  "summarization_threshold": 3000,  # –ü–æ—Ä–æ–≥ –∞–≤—Ç–æ-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
  "summarization_max_output": 1500  # –ú–∞–∫—Å —Ç–æ–∫–µ–Ω–æ–≤ –≤ summary
}
```

**–§–æ—Ä–º—É–ª–∞ –ø–æ—Ä–æ–≥–∞:**
```python
summarization_threshold = effective_context_for_rag * 0.4
effective_context = context_window - max_output_tokens - 500 (overhead)
```

### –ê–ª–≥–æ—Ä–∏—Ç–º –≤ `/ask`

```python
# 1. –ü–æ–∏—Å–∫ –∏ ranking
results = search(query, top_k=20)  # –ù–∞—Ö–æ–¥–∏–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —á–∞–Ω–∫–∏

# 2. –ü–æ–¥—Å—á—ë—Ç —Ç–æ–∫–µ–Ω–æ–≤
context_tokens = count_tokens(results)

# 3. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ –º–æ–¥–µ–ª–∏
model_config = get_current_model_config()
threshold = model_config.summarization_threshold  # 3000 –¥–ª—è llama3.1:8b

# 4. –†–µ—à–µ–Ω–∏–µ
if context_tokens > threshold:  # 5000 > 3000
    # –°—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
    summary = summarize_chunks(results, query, max_tokens=1500)
    prompt = build_prompt_with_summary(summary, query)
else:
    # –û–±—ã—á–Ω—ã–π RAG
    prompt = build_prompt(results, query)

# 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
answer = call_llm(prompt)
```

### –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

| –ú–æ–¥–µ–ª—å | Context | Threshold | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
|--------|---------|-----------|-----------|
| **Llama 8B** | 8K | 3K | –ß–∞—Å—Ç–æ —Å—É–º–º–∞—Ä–∏–∑–∏—Ä—É–µ—Ç |
| **Llama 70B FP8** | 16K | 6K | –°—Ä–µ–¥–Ω–µ |
| **Mixtral 8x7B** | 32K | 12K | –†–µ–¥–∫–æ |
| **GPT-4 Turbo** | 128K | 50K | –ü–æ—á—Ç–∏ –Ω–∏–∫–æ–≥–¥–∞ |

### Response `/ask`

```json
{
  "answer": "Based on the documents...",
  "sources": [...],
  "summarized": true,        # –ë—ã–ª–∞ –ª–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
  "context_tokens": 5000,    # –ò—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä
  "model": "llama3.1:8b"
}
```

### Endpoint –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
GET /model-config

# Response:
{
  "model_name": "llama3.1:8b",
  "context_window": 8192,
  "summarization_threshold": 3000,
  "effective_context_for_rag": 7180,
  "tokens_per_second": 50
}
```

### Use Cases

- RAG —Å –±–æ–ª—å—à–∏–º `top_k` (20-50 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
- –ú–æ–¥–µ–ª–∏ —Å –º–∞–ª—ã–º context window
- –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è latency

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –º–æ–¥–µ–ª—å  
‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
‚úÖ –≠–∫–æ–Ω–æ–º–∏—Ç —Ç–æ–∫–µ–Ω—ã (–¥–æ 75%)  
‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç out-of-the-box

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ö†Ô∏è –ú–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏  
‚ö†Ô∏è –î–æ–±–∞–≤–ª—è–µ—Ç latency (–µ—Å–ª–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç)

---

## –ü–∞—Ç—Ç–µ—Ä–Ω 3: –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### –û–ø–∏—Å–∞–Ω–∏–µ

–Ø–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `mode` –≤ `/ask`. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ frontend –≤—ã–±–∏—Ä–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

### –†–µ–∂–∏–º—ã

#### 1. `mode: "auto"` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
–£–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Ä–æ–≥–∞ –º–æ–¥–µ–ª–∏ (–∫–∞–∫ –≤ –ü–∞—Ç—Ç–µ—Ä–Ω–µ 2).

```bash
POST /ask
{
  "q": "What are the project deadlines?",
  "space_id": "demo",
  "mode": "auto"
}
```

#### 2. `mode: "normal"`
–û–±—ã—á–Ω—ã–π RAG –±–µ–∑ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

```bash
POST /ask
{
  "q": "List all deadlines",
  "mode": "normal",
  "top_k": 20
}
# ‚Üí –û—Ç–¥–∞—Å—Ç –≤—Å–µ 20 —á–∞–Ω–∫–æ–≤ –≤ LLM
```

#### 3. `mode: "summarize"`
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–∞–ª—ã–π.

```bash
POST /ask
{
  "q": "Give me a brief overview",
  "mode": "summarize"
}
# ‚Üí –°—É–º–º–∞—Ä–∏–∑–∏—Ä—É–µ—Ç –¥–∞–∂–µ 2-3 —á–∞–Ω–∫–∞
```

#### 4. `mode: "detailed"`
–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏.

```bash
POST /ask
{
  "q": "List ALL project details with dates",
  "mode": "detailed",
  "top_k": 50
}
# ‚Üí –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å—É–º–º–∞—Ä–∏–∑–∏—Ä—É–µ—Ç
```

### Response

```json
{
  "answer": "...",
  "mode": "summarize",      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
  "summarized": true,       # –ë—ã–ª–∞ –ª–∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
  "context_tokens": 2000
}
```

### –ú–∞—Ç—Ä–∏—Ü–∞ —Ä–µ—à–µ–Ω–∏–π

```
–í–æ–ø—Ä–æ—Å                          ‚Üí –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–µ–∂–∏–º
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
"–î–∞–π –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä..."          ‚Üí summarize
"–ü–µ—Ä–µ—á–∏—Å–ª–∏ –í–°–ï..."              ‚Üí detailed
"–ß—Ç–æ —Ç–∞–∫–æ–µ X?"                  ‚Üí normal
–ù–µ —É–≤–µ—Ä–µ–Ω                       ‚Üí auto
```

### Frontend Integration

```typescript
// React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
const [mode, setMode] = useState<'auto' | 'normal' | 'summarize' | 'detailed'>('auto');

<select value={mode} onChange={e => setMode(e.target.value)}>
  <option value="auto">ü§ñ Smart</option>
  <option value="summarize">üìÑ Brief</option>
  <option value="detailed">üìã Detailed</option>
</select>

// API call
const response = await fetch('/ask', {
  body: JSON.stringify({
    q: question,
    mode: mode
  })
});

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
{response.summarized && (
  <Badge>Summarized from {response.context_tokens} tokens</Badge>
)}
```

### Use Cases

- **Dashboard**: `mode: "summarize"` –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
- **Analytics**: `mode: "detailed"` –¥–ª—è –æ—Ç—á—ë—Ç–æ–≤
- **Chat**: `mode: "auto"` –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- **Search results**: `mode: "normal"` –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ü–∏—Ç–∞—Ç

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ –Ø–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
‚úÖ –†–∞–∑–Ω—ã–µ use cases  
‚úÖ Graceful fallback –Ω–∞ `auto`  
‚úÖ Frontend-friendly

---

## –ü–∞—Ç—Ç–µ—Ä–Ω 4: –ü—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ summaries

### –û–ø–∏—Å–∞–Ω–∏–µ

Pre-compute summaries –ø—Ä–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏–∏. Instant retrieval –≤–º–µ—Å—Ç–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–î–≤–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:**

```
rag_embeddings (–æ—Å–Ω–æ–≤–Ω–∞—è):
‚îú‚îÄ‚îÄ chunk 0: {text, doc_id, has_summary: true, summary_id: "uuid"}
‚îú‚îÄ‚îÄ chunk 1: {text, doc_id, has_summary: true}
‚îî‚îÄ‚îÄ ...

document_summaries (–Ω–æ–≤–∞—è):
‚îî‚îÄ‚îÄ {
      doc_id: "doc_123",
      summary: "Full summary text...",
      summary_tokens: 150,
      generated_at: "2025-01-10",
      model: "llama3.1:8b"
    }
```

### API

#### 1. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å summary

```bash
POST /ingest?generate_summary=true
  -F file=@document.pdf
  -F space_id=demo

# Response (—á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã):
{
  "doc_id": "doc_123",
  "chunks_indexed": 25,
  "summary_pending": true  # –í —Ñ–æ–Ω–µ!
}
```

**Flow:**
```
1. –ü–∞—Ä—Å–∏–Ω–≥ –∏ chunking (3s)
2. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ rag_embeddings
3. –í–æ–∑–≤—Ä–∞—Ç response
4. Background task:
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è summary (15s)
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ document_summaries
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ has_summary=true
```

#### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ summary

```bash
POST /summarize
{
  "doc_id": "doc_123",
  "space_id": "demo"
}

# Response (0.1 —Å–µ–∫—É–Ω–¥–∞!):
{
  "summary": "...",
  "cached": true,         # –ò–∑ –∫—ç—à–∞!
  "generated_at": "..."
}
```

#### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
GET /documents/doc_123/summary-status?space_id=demo

{
  "has_summary": true,
  "summary_preview": "This document...",
  "summary_tokens": 150,
  "generated_at": "2025-01-10"
}
```

#### 4. Bulk –æ–ø–µ—Ä–∞—Ü–∏–∏

```bash
# –°—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –±–µ–∑ summaries
POST /bulk-summarize?space_id=demo&limit=100

{
  "documents_to_process": 15,
  "doc_ids": ["doc_1", "doc_2", ...],
  "status": "scheduled"
}
```

#### 5. –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è

```bash
# –ü–æ—Å–ª–µ —Å–º–µ–Ω—ã –º–æ–¥–µ–ª–∏ LLM
POST /documents/doc_123/regenerate-summary?space_id=demo

{
  "status": "pending",
  "message": "Summary regeneration scheduled"
}
```

#### 6. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```bash
GET /summary-stats?space_id=demo

{
  "total_summaries": 45,
  "total_tokens": 6750,
  "average_tokens": 150,
  "by_space": {...},
  "by_doc_type": {...}
}
```

### Performance

| Operation | –ë–µ–∑ –∫—ç—à–∞ | –° –∫—ç—à–æ–º | –£–ª—É—á—à–µ–Ω–∏–µ |
|-----------|----------|---------|-----------|
| –ü–µ—Ä–≤—ã–π `/summarize` | 15s | 15s | - |
| –ü–æ–≤—Ç–æ—Ä–Ω—ã–π | 15s | **0.1s** | **150x** |
| Dashboard (10 docs) | 150s | **1s** | **150x** |
| –í—Ä–µ–º—è `/ingest` | 3s | **3s** | –ë–µ–∑ –≤–ª–∏—è–Ω–∏—è |

### Use Cases

#### 1. Document Library
```typescript
// Instant previews
const docs = await fetchDocuments();

for (const doc of docs) {
  const status = await fetch(`/documents/${doc.id}/summary-status`);
  if (status.has_summary) {
    showPreview(status.summary_preview);
  }
}
// ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –ø—Ä–µ–≤—å—é
```

#### 2. Dashboard Cards
```typescript
// Load summaries for all projects
const summaries = await Promise.all(
  projectIds.map(id => fetch('/summarize', {body: {doc_id: id}}))
);
// ‚úÖ –í—Å–µ –∏–∑ –∫—ç—à–∞, instant load
```

#### 3. Batch Upload
```typescript
// Upload many documents
for (const file of files) {
  await uploadFile(file, {generate_summary: true});
}
// ‚úÖ Summaries –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ 150x –±—ã—Å—Ç—Ä–µ–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã  
‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é  
‚úÖ Dashboard-friendly  
‚úÖ –õ–µ–≥–∫–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ —Å–º–µ–Ω–µ –º–æ–¥–µ–ª–∏

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (summaries collection)  
‚ö†Ô∏è –ù–µ–º–Ω–æ–≥–æ —Å–ª–æ–∂–Ω–µ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

---

## –ü–∞—Ç—Ç–µ—Ä–Ω 5: –ü–æ—Ç–æ–∫–æ–≤–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è

### –û–ø–∏—Å–∞–Ω–∏–µ

Progressive streaming —Å Server-Sent Events (SSE). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å, partial results –∏ ETA –≤–º–µ—Å—Ç–æ —Å–ª–µ–ø–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è.

### API

```bash
POST /summarize-stream
{
  "doc_id": "large_document",
  "space_id": "demo"
}

# Server-Sent Events (SSE):
data: {"type":"start","total_tokens":15000,"strategy":"map_reduce","progress":0}

data: {"type":"processing","progress":5,"eta_seconds":45}

data: {"type":"progress","stage":"map","current":1,"total":3,"progress":30,"eta_seconds":30}

data: {"type":"partial_summary","chunk":1,"summary":"Section 1 discusses..."}

data: {"type":"progress","stage":"reduce","progress":75}

data: {"type":"summary","text":"Final summary...","progress":100}

data: {"type":"complete","total_time":42.5}
```

### Event Types

| Type | –û–ø–∏—Å–∞–Ω–∏–µ | Fields |
|------|----------|--------|
| `start` | –ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ | `total_tokens`, `strategy`, `map_chunks` |
| `processing` | –û–±—Ä–∞–±–æ—Ç–∫–∞ | `message`, `progress`, `eta_seconds` |
| `progress` | Map/Reduce –ø—Ä–æ–≥—Ä–µ—Å—Å | `stage`, `current`, `total`, `eta_seconds` |
| `partial_summary` | –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç | `chunk`, `summary`, `tokens` |
| `summary` | –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç | `text`, `tokens`, `processing_time` |
| `complete` | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ | `total_time`, `tokens_processed` |
| `cached` | –ò–∑ –∫—ç—à–∞ | `summary`, `progress`: 100 |
| `error` | –û—à–∏–±–∫–∞ | `message` |

### ETA Calculation

```python
model_config = get_current_model_config()
tokens_per_second = model_config.tokens_per_second  # 50 –¥–ª—è llama3.1:8b

remaining_tokens = total_tokens - processed_tokens
eta_seconds = remaining_tokens / tokens_per_second

# –î–ª—è Map-Reduce –¥–æ–±–∞–≤–ª—è–µ–º overhead
if strategy == "map_reduce":
    eta_seconds *= 1.5  # +50% –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
```

### Frontend Integration

```typescript
async function streamingSummarize(docId: string) {
  const response = await fetch('/summarize-stream', {
    method: 'POST',
    body: JSON.stringify({doc_id: docId, space_id: 'demo'})
  });
  
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  
  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value);
    const events = chunk.split('\n')
      .filter(line => line.startsWith('data: '))
      .map(line => JSON.parse(line.substring(6)));
    
    for (const event of events) {
      switch (event.type) {
        case 'progress':
          updateProgress(event.progress, event.eta_seconds);
          break;
        case 'partial_summary':
          addPartialResult(event.chunk, event.summary);
          break;
        case 'summary':
          showFinalSummary(event.text);
          break;
      }
    }
  }
}
```

### Visual Demo

**–§–∞–π–ª:** `static/streaming_demo.html`

Beautiful responsive UI:
- Progress bar —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
- Status messages —Å ETA
- Spinner animation
- Partial results display
- Cancel button
- Error handling

**–û—Ç–∫—Ä—ã—Ç—å:**
```bash
open http://localhost:8000/static/streaming_demo.html
```

### Long Polling Fallback

–î–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ SSE:

```bash
POST /summarize-poll
{
  "doc_id": "doc_123",
  "space_id": "demo"
}

# Response:
{
  "task_id": "task_abc",
  "status": "pending",
  "recommendation": "Use /summarize-stream for real-time progress"
}
```

### Use Cases

- **–ë–æ–ª—å—à–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã** (100+ —Å—Ç—Ä–∞–Ω–∏—Ü, 15K+ —Ç–æ–∫–µ–Ω–æ–≤)
- **Interactive dashboards** —Å visual feedback
- **User-facing applications** –≥–¥–µ UX –≤–∞–∂–µ–Ω
- **Multi-document summaries** —Å long processing time

### Comparison

| Feature | `/summarize` | `/summarize-stream` |
|---------|--------------|---------------------|
| **Feedback** | ‚ùå –ù–µ—Ç | ‚úÖ Real-time |
| **Progress** | ‚ùå –ù–µ—Ç | ‚úÖ 0-100% |
| **ETA** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| **Partial results** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| **Cancellable** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| **Wait feeling** | üò¥ –î–æ–ª–≥–æ | üëÄ –í–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å |

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å  
‚úÖ User engagement  
‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å  
‚úÖ –í–∏–¥–Ω—ã –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã  
‚úÖ ETA visibility

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ö†Ô∏è –°–ª–æ–∂–Ω–µ–µ frontend integration  
‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç SSE support –≤ –±—Ä–∞—É–∑–µ—Ä–µ

---

## –ü–∞—Ç—Ç–µ—Ä–Ω 6: –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–¥–æ–≤

### –û–ø–∏—Å–∞–Ω–∏–µ

Structured summarization conversation threads (email, chat, messengers) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º action items, decisions –∏ topics.

### –î–≤–∞ use case

#### 1. User Chat (Real-time)
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ –∏ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é.

#### 2. File Upload
–ü–∞—Ä—Å–∏–Ω–≥ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è email/chat —Ñ–∞–π–ª–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–µ–π.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–¢—Ä–∏ –Ω–æ–≤—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:**

```
chat_messages:
‚îú‚îÄ‚îÄ {thread_id, sender, text, timestamp, chat_type, recipients}
‚îî‚îÄ‚îÄ –ò–Ω–¥–µ–∫—Å—ã: thread_id, space_id, sender

thread_summaries:
‚îú‚îÄ‚îÄ {thread_id, summary, action_items[], decisions[], topics[]}
‚îú‚îÄ‚îÄ {participants[], message_count, start_date, end_date}
‚îî‚îÄ‚îÄ –ò–Ω–¥–µ–∫—Å: thread_id, space_id
```

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

#### Email
```
From: Alice <alice@example.com>
Date: Mon, 10 Jan 2025 10:00:00
To: Bob <bob@example.com>
Subject: Project Discussion

Message body...
```

#### Telegram
```
[10.01.2025, 10:00] Alice: Message text
[10.01.2025, 10:05] Bob: Reply text
```

#### WhatsApp
```
10/01/2025, 10:00 - Alice: Message text
10/01/2025, 10:05 - Bob: Reply text
```

### API: User Chat

#### –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ

```bash
POST /chat/message
{
  "thread_id": "project_alpha",
  "space_id": "demo",
  "sender": "Alice",
  "text": "Bob, can you prepare the budget by Friday?",
  "recipients": ["Bob"],
  "chat_type": "user_chat"
}

# Response:
{
  "message_id": "msg_uuid",
  "thread_id": "project_alpha",
  "status": "saved"
}
```

#### –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è

```bash
GET /chat/thread/project_alpha/messages?space_id=demo&limit=100

{
  "message_count": 15,
  "messages": [
    {
      "sender": "Alice",
      "text": "...",
      "timestamp": "2025-01-10T10:00:00"
    },
    ...
  ]
}
```

#### –°—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–¥

```bash
POST /thread/summarize
{
  "thread_id": "project_alpha",
  "space_id": "demo",
  "extract_action_items": true,
  "extract_decisions": true,
  "extract_topics": true
}

# Response:
{
  "thread_id": "project_alpha",
  "summary": "Team discussed budget preparation. Alice requested completion by Friday. Bob committed to Wednesday delivery.",
  
  "participants": ["Alice", "Bob"],
  "message_count": 15,
  "start_date": "2025-01-10",
  "end_date": "2025-01-12",
  
  "action_items": [
    {
      "task": "Prepare budget",
      "owner": "Bob",
      "deadline": "Wednesday",
      "priority": null
    }
  ],
  
  "decisions": [
    "Budget deadline set to Friday",
    "Bob responsible for preparation"
  ],
  
  "topics": [
    "Budget Planning",
    "Timeline",
    "Responsibilities"
  ]
}
```

#### –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π summary

```bash
GET /thread/project_alpha/summary?space_id=demo

# Instant retrieval –∏–∑ thread_summaries collection
```

### API: File Upload

```bash
POST /ingest-thread
  -F file=@email_thread.txt
  -F space_id=demo
  -F thread_type=email
  -F auto_summarize=true

# Response:
{
  "thread_id": "email_thread_abc123",
  "messages": 8,
  "participants": ["Alice", "Bob", "Charlie"],
  "start_date": "2025-01-10",
  "end_date": "2025-01-15",
  "summary_pending": true  # –í —Ñ–æ–Ω–µ
}
```

### Action Items

**–ß—Ç–æ —ç—Ç–æ:**
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞—á, TODO –∏ assignments –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.

**–ü—Ä–∏–º–µ—Ä—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**

```
–§—Ä–∞–∑–∞ –≤ —á–∞—Ç–µ ‚Üí Action Item

"Bob, prepare report by Monday"
‚Üí {task: "Prepare report", owner: "Bob", deadline: "Monday"}

"Alice will review the proposal"
‚Üí {task: "Review proposal", owner: "Alice", deadline: null}

"We need to schedule a meeting (high priority)"
‚Üí {task: "Schedule meeting", owner: null, deadline: null, priority: "high"}

"Charlie, finish design by EOW"
‚Üí {task: "Finish design", owner: "Charlie", deadline: "end of week"}
```

**Use Cases:**
- Dashboard —Å –∑–∞–¥–∞—á–∞–º–∏ –∫–æ–º–∞–Ω–¥—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Jira/Asana
- Task tracking
- Deadline monitoring

### –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–¥–æ–≤

```bash
GET /threads?space_id=demo&chat_type=email_thread&limit=50

{
  "thread_count": 12,
  "threads": [
    {
      "thread_id": "email_001",
      "chat_type": "email_thread",
      "participants": ["Alice", "Bob"],
      "message_count": 8,
      "start_date": "2025-01-10",
      "summary_preview": "Discussion about...",
      "has_action_items": true
    },
    ...
  ]
}
```

### –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–¥–∞

```bash
DELETE /thread/project_alpha?space_id=demo

# –£–¥–∞–ª—è–µ—Ç:
# - –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ chat_messages
# - Summary –∏–∑ thread_summaries
```

### Use Cases

#### 1. Team Chat Application
```typescript
// Real-time —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
socket.on('message', async (msg) => {
  await saveMessage(conversationId, msg.user, msg.text);
});

// End of day summary
const summary = await summarizeThread(conversationId);
showTeamSummary(summary);
showActionItems(summary.action_items);
```

#### 2. Email Archive
```bash
# Bulk –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è email —Ç—Ä–µ–¥–æ–≤
for file in emails/*.txt; do
  curl -F "file=@$file" -F "thread_type=email" /ingest-thread
done

# –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ RAG –ø–æ –≤—Å–µ–º email
curl '/ask' -d '{"q":"What was decided about the budget?"}'
```

#### 3. Action Items Dashboard
```typescript
const threads = await getThreads();
const allActions = threads
  .filter(t => t.has_action_items)
  .flatMap(t => t.action_items);

const byOwner = groupBy(allActions, 'owner');
const byDeadline = sortBy(allActions, 'deadline');

<ActionItemsBoard 
  items={allActions}
  groupBy="owner"
  showDeadlines={true}
/>
```

#### 4. Meeting Notes Alternative
```typescript
// –í–º–µ—Å—Ç–æ –∑–∞–ø–∏—Å–∏ meeting notes
// 1. –ß–∞—Ç –≤–æ –≤—Ä–µ–º—è meeting
chatDuringMeeting(meetingId);

// 2. Auto-generate summary
const summary = await summarizeThread(meetingId);

// 3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å action items
distributeActionItems(summary.action_items);

// 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å decisions
recordDecisions(summary.decisions);
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏—è action items  
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ Qdrant  
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multiple —Ñ–æ—Ä–º–∞—Ç–æ–≤  
‚úÖ Real-time –∏ file upload  
‚úÖ Searchable —á–µ—Ä–µ–∑ RAG

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

‚ö†Ô∏è –ö–∞—á–µ—Å—Ç–≤–æ —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç LLM  
‚ö†Ô∏è Action items –º–æ–≥—É—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å review

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ú–æ–¥—É–ª–∏

```
backend/services/
‚îú‚îÄ‚îÄ summarization.py              # Core: Map-Reduce, streaming
‚îÇ   ‚îú‚îÄ‚îÄ summarize_text()         # –ü—Ä–æ—Å—Ç–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ summarize_long_text()    # Map-Reduce
‚îÇ   ‚îú‚îÄ‚îÄ summarize_document_by_id() # –ü–æ doc_id
‚îÇ   ‚îú‚îÄ‚îÄ summarize_chunks()       # –ò–∑ search results
‚îÇ   ‚îî‚îÄ‚îÄ summarize_document_streaming() # SSE streaming
‚îÇ
‚îú‚îÄ‚îÄ llm_config.py                # Model configurations
‚îÇ   ‚îú‚îÄ‚îÄ LLMModelConfig          # Dataclass
‚îÇ   ‚îú‚îÄ‚îÄ LLMModelRegistry        # Registry
‚îÇ   ‚îî‚îÄ‚îÄ get_current_model_config() # Active model
‚îÇ
‚îú‚îÄ‚îÄ summary_store.py             # Pre-computed summaries
‚îÇ   ‚îú‚îÄ‚îÄ save_document_summary()
‚îÇ   ‚îú‚îÄ‚îÄ get_document_summary()
‚îÇ   ‚îî‚îÄ‚îÄ Collection: document_summaries
‚îÇ
‚îú‚îÄ‚îÄ thread_parser.py             # Thread parsing
‚îÇ   ‚îú‚îÄ‚îÄ parse_email_thread()
‚îÇ   ‚îú‚îÄ‚îÄ parse_telegram_chat()
‚îÇ   ‚îî‚îÄ‚îÄ parse_whatsapp_chat()
‚îÇ
‚îú‚îÄ‚îÄ thread_store.py              # Thread storage
‚îÇ   ‚îú‚îÄ‚îÄ save_chat_message()
‚îÇ   ‚îú‚îÄ‚îÄ get_thread_messages()
‚îÇ   ‚îú‚îÄ‚îÄ save_thread_summary()
‚îÇ   ‚îî‚îÄ‚îÄ Collections: chat_messages, thread_summaries
‚îÇ
‚îî‚îÄ‚îÄ thread_summarization.py     # Thread summarization
    ‚îú‚îÄ‚îÄ summarize_thread()
    ‚îî‚îÄ‚îÄ Extract: action_items, decisions, topics
```

### Qdrant Collections

```
1. rag_embeddings (main)
   - Document chunks + embeddings
   - Payload: has_summary flag

2. document_summaries (Pattern 4)
   - Pre-computed document summaries
   - Fast retrieval

3. chat_messages (Pattern 6)
   - Individual messages
   - thread_id grouping

4. thread_summaries (Pattern 6)
   - Structured thread summaries
   - action_items, decisions, topics
```

### API Endpoints

```
Document Summarization:
‚îú‚îÄ‚îÄ POST /summarize              # Pattern 1: Direct
‚îú‚îÄ‚îÄ POST /summarize-stream       # Pattern 5: Streaming (SSE)
‚îú‚îÄ‚îÄ POST /summarize-poll         # Pattern 5: Long polling fallback
‚îú‚îÄ‚îÄ GET  /documents/{id}/summary-status  # Pattern 4: Check status
‚îú‚îÄ‚îÄ POST /documents/{id}/regenerate-summary  # Pattern 4: Regenerate
‚îú‚îÄ‚îÄ POST /bulk-summarize         # Pattern 4: Bulk operation
‚îú‚îÄ‚îÄ GET  /summary-stats          # Pattern 4: Statistics
‚îî‚îÄ‚îÄ DELETE /documents/{id}/summary  # Pattern 4: Delete

Context Compression (Pattern 2):
‚îî‚îÄ‚îÄ Integrated in POST /ask      # Smart auto-summarization

Mode Control (Pattern 3):
‚îî‚îÄ‚îÄ POST /ask?mode=auto|normal|summarize|detailed

Model Configuration (Pattern 2):
‚îî‚îÄ‚îÄ GET /model-config            # Current model settings

Thread Operations (Pattern 6):
‚îú‚îÄ‚îÄ POST /chat/message           # Save message
‚îú‚îÄ‚îÄ GET  /chat/thread/{id}/messages  # Get messages
‚îú‚îÄ‚îÄ POST /thread/summarize       # Summarize thread
‚îú‚îÄ‚îÄ GET  /thread/{id}/summary    # Get summary
‚îú‚îÄ‚îÄ POST /ingest-thread          # Upload thread file
‚îú‚îÄ‚îÄ GET  /threads                # List threads
‚îî‚îÄ‚îÄ DELETE /thread/{id}          # Delete thread
```

### Configuration Files

```
config/
‚îî‚îÄ‚îÄ llm_models.json              # Model configurations
    ‚îú‚îÄ‚îÄ Ollama models: llama3.1:8b, mistral:7b, qwen2.5:7b
    ‚îú‚îÄ‚îÄ vLLM models: Llama-8B, Llama-70B-FP8, Mixtral
    ‚îî‚îÄ‚îÄ Cloud models: GPT-4, GPT-4 Turbo, Claude-3

docs/threads/
‚îî‚îÄ‚îÄ README.md                    # Thread file formats guide
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### Quick Start

#### 1. –ü—Ä–æ—Å—Ç–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è

```bash
# Upload document
curl -F "file=@doc.pdf" -F "space_id=demo" /ingest

# Summarize
curl -X POST /summarize -d '{"doc_id":"doc_123","space_id":"demo"}'
```

#### 2. –° –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º

```bash
# Upload —Å auto-summary
curl -F "file=@doc.pdf" -F "generate_summary=true" /ingest

# Instant retrieval (0.1s)
curl -X POST /summarize -d '{"doc_id":"doc_123","space_id":"demo"}'
# ‚Üí cached: true
```

#### 3. Streaming –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

```bash
curl -X POST /summarize-stream \
  -d '{"doc_id":"large_doc","space_id":"demo"}' \
  --no-buffer

# Real-time progress + ETA
```

#### 4. Smart RAG —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç compression

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—É–º–º–∞—Ä–∏–∑–∏—Ä—É–µ—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
curl -X POST /ask \
  -d '{
    "q": "What are all the project deadlines?",
    "space_id": "demo",
    "top_k": 30
  }'

# Response: summarized: true/false
```

#### 5. –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

```bash
# Brief overview
curl -X POST /ask -d '{"q":"overview","mode":"summarize"}'

# Full details
curl -X POST /ask -d '{"q":"all details","mode":"detailed","top_k":50}'
```

#### 6. Thread summarization

```bash
# Save chat messages
curl -X POST /chat/message \
  -d '{"thread_id":"chat1","sender":"Alice","text":"..."}'

# Summarize with action items
curl -X POST /thread/summarize \
  -d '{"thread_id":"chat1","extract_action_items":true}'
```

### Production Recommendations

#### 1. –í—ã–±–æ—Ä –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

```
Use Case                          ‚Üí Pattern
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
One-time doc summary              ‚Üí Pattern 1
RAG with large top_k              ‚Üí Pattern 2
User control needed               ‚Üí Pattern 3
Document library/dashboard        ‚Üí Pattern 4
Large docs, UX important          ‚Üí Pattern 5
Chat/email processing             ‚Üí Pattern 6
```

#### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```bash
# .env
LLM_MODEL=llama3.1:8b
LLM_MODE=ollama

# –ú–æ–¥–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# –°–º–æ—Ç—Ä–∏: config/llm_models.json
```

#### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# Check summaries stats
curl /summary-stats?space_id=demo

# Model config
curl /model-config

# Thread stats
curl /threads?space_id=demo
```

#### 4. Performance Tuning

```yaml
# –î–ª—è –±—ã—Å—Ç—Ä–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: small model
LLM_MODEL: llama3.1:8b
tokens_per_second: 250 (vLLM)

# –î–ª—è –∫–∞—á–µ—Å—Ç–≤–∞: large model
LLM_MODEL: llama3.1:70b
context_window: 16K

# –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
LLM_MODEL: mistralai/Mixtral-8x7B-Instruct-v0.1
context_window: 32K
```

### –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

#### Example 1: Document Library

```typescript
// Pattern 4: Pre-compute summaries –ø—Ä–∏ upload
await uploadDocuments(files, {generate_summary: true});

// Pattern 4: Instant display
const docs = await getDocuments();
for (const doc of docs) {
  const summary = await getSummary(doc.id);  // 0.1s, cached!
  showCard(doc, summary.summary_preview);
}
```

#### Example 2: Interactive Dashboard

```typescript
// Pattern 3: User control
const mode = userPreference;  // "summarize" for dashboard

// Pattern 2: Auto-optimization
const response = await ask(query, {
  mode: mode,
  top_k: 30
});

// Pattern 5: Streaming –¥–ª—è detail view
if (needsDetail) {
  streamingSummarize(docId, showProgress);
}
```

#### Example 3: Team Collaboration

```typescript
// Pattern 6: Save chat messages
socket.on('message', msg => saveMessage(threadId, msg));

// Pattern 6: Daily summary
scheduleDaily(async () => {
  const summary = await summarizeThread(threadId);
  sendEmail(team, summary);
  
  // Extract action items
  createTasks(summary.action_items);
});

// Pattern 4: Cache summaries
await Promise.all(
  allThreads.map(t => summarizeThread(t.id))
);
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏

**6 –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:**

1. ‚úÖ **–ü—Ä—è–º–∞—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è** - –±–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
2. ‚úÖ **Smart Compression** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
3. ‚úÖ **–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã** - —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
4. ‚úÖ **Pre-computed** - 150x –±—ã—Å—Ç—Ä–µ–µ
5. ‚úÖ **Streaming** - UX –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
6. ‚úÖ **–¢—Ä–µ–¥—ã** - structured —Å action items

### –ü–æ–∫—Ä—ã–≤–∞–µ–º—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

- ‚úÖ –ú–∞–ª—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (< 8K —Ç–æ–∫–µ–Ω–æ–≤)
- ‚úÖ –°—Ä–µ–¥–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (8-32K —Ç–æ–∫–µ–Ω–æ–≤)
- ‚úÖ –ë–æ–ª—å—à–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (32K+ —Ç–æ–∫–µ–Ω–æ–≤)
- ‚úÖ RAG —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- ‚úÖ Interactive applications
- ‚úÖ Document libraries
- ‚úÖ Dashboards
- ‚úÖ Email/chat processing
- ‚úÖ Team collaboration
- ‚úÖ Action item tracking

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ–∑–∞–≤–∏—Å–∏–º
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: background tasks, streaming
- **–ì–∏–±–∫–æ—Å—Ç—å**: multiple —Ä–µ–∂–∏–º—ã –∏ –æ–ø—Ü–∏–∏
- **Performance**: –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, async
- **UX**: streaming, progress, ETA
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º RAG

### Next Steps

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è:**

1. **Batch Processing**
   - –ú–∞—Å—Å–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
   - Scheduled summaries

2. **Multi-language Support**
   - –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–∞—Ö
   - Translation + summarization

3. **Custom Templates**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–º–ø—Ç—ã
   - Industry-specific summaries

4. **Analytics**
   - Tracking usage
   - Quality metrics
   - Cost optimization

5. **Notifications**
   - Action item reminders
   - Deadline alerts
   - Summary digests

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [SUMMARIZATION_QUICKSTART.md](../SUMMARIZATION_QUICKSTART.md)
- [ASK_MODES_GUIDE.md](ASK_MODES_GUIDE.md)
- [SUMMARY_STORAGE_GUIDE.md](SUMMARY_STORAGE_GUIDE.md)
- [STREAMING_QUICKSTART.md](../STREAMING_QUICKSTART.md)
- [THREADS_QUICKSTART.md](../THREADS_QUICKSTART.md)
- [LLM_MODEL_CONFIGURATION.md](LLM_MODEL_CONFIGURATION.md)

---

**üéâ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö PRODUCTION –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ! üéâ**

