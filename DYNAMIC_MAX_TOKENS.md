# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç max_tokens

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–¢–µ–ø–µ—Ä—å `max_tokens` —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–æ–¥–µ–ª–∏** (–∏–∑ `llm_models.json`)
2. **–†–∞–∑–º–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞** (—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π input)
3. **Safety margin** (–∑–∞–ø–∞—Å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤ `backend/services/rag.py`:

```python
def calculate_dynamic_max_tokens(
    prompt: str, 
    context_window: int, 
    safety_margin: int = 500
) -> int:
    """
    –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞–∫—Å —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –æ—Ç–≤–µ—Ç–∞
    
    –§–æ—Ä–º—É–ª–∞:
    available = context_window - prompt_tokens - safety_margin
    """
    prompt_tokens = len(prompt.split())  # –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç
    available = context_window - prompt_tokens - safety_margin
    
    # –ù–µ –º–µ–Ω—å—à–µ 256, –Ω–µ –±–æ–ª—å—à–µ 4096
    return max(256, min(available, 4096))
```

### 2. –û–±–Ω–æ–≤–ª—ë–Ω `call_llm()` –¥–ª—è –ø—Ä–∏—ë–º–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ `max_tokens`:

```python
def call_llm(prompt: str, max_tokens: int = None) -> str:
    if LLM_MODE == "ollama":
        num_predict = max_tokens if max_tokens is not None else LLM_MAX_TOKENS
        ...
    elif LLM_MODE == "vllm":
        kwargs = {}
        if max_tokens is not None:
            kwargs['max_tokens'] = max_tokens
        return call_vllm(prompt, **kwargs)
```

### 3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏:

```python
# –í summarize_text()
model_config = get_current_model_config()
dynamic_max = calculate_dynamic_max_tokens(prompt, model_config.context_window)
actual_max = min(max_summary_tokens, dynamic_max)

print(f"Dynamic max_tokens: {actual_max} (requested: {max_summary_tokens}, available: {dynamic_max})")

summary = call_llm(prompt, max_tokens=actual_max)
```

---

## üìä –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏–º–µ—Ä –¥–ª—è llama3.1:8b

**–ú–æ–¥–µ–ª—å:**
- context_window = 8192 —Ç–æ–∫–µ–Ω–æ–≤

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ú–∞–ª–µ–Ω—å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç (–∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç)**

```
prompt_tokens = 500
available = 8192 - 500 - 500 = 7192
dynamic_max = min(7192, 4096) = 4096
actual_max = min(500, 4096) = 500  ‚úÖ
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ë–æ–ª—å—à–æ–π –¥–æ–∫—É–º–µ–Ω—Ç (–¥–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç)**

```
prompt_tokens = 6000
available = 8192 - 6000 - 500 = 1692
dynamic_max = min(1692, 4096) = 1692
actual_max = min(1500, 1692) = 1500  ‚úÖ
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –û—á–µ–Ω—å –±–æ–ª—å—à–æ–π –ø—Ä–æ–º–ø—Ç**

```
prompt_tokens = 7500
available = 8192 - 7500 - 500 = 192
dynamic_max = max(256, min(192, 4096)) = 256  ‚úÖ –ú–∏–Ω–∏–º—É–º
actual_max = min(1500, 256) = 256  ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
```

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å

**–ë—ã–ª–æ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ):**
```python
call_llm(prompt)  # –í—Å–µ–≥–¥–∞ LLM_MAX_TOKENS=2048
```

–ü—Ä–æ–±–ª–µ–º—ã:
- ‚ùå –ö–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç ‚Üí –∑—Ä—è —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º 2048 —Ç–æ–∫–µ–Ω–æ–≤
- ‚ùå –î–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚Üí –º–æ–∂–µ—Ç –Ω–µ –≤–ª–µ–∑—Ç—å –≤ context_window

**–°—Ç–∞–ª–æ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ):**
```python
dynamic_max = calculate_dynamic_max_tokens(prompt, context_window)
call_llm(prompt, max_tokens=dynamic_max)
```

–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º–ø—Ç ‚Üí –º–æ–∂–µ—Ç –¥–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
- ‚úÖ –î–ª–∏–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–º–µ–Ω—å—à–∞–µ—Ç max_tokens
- ‚úÖ –í—Å–µ–≥–¥–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ

---

## üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: llama3.1:8b vs qwen3:14b

### llama3.1:8b (context_window = 8192)

```
–ü—Ä–æ–º–ø—Ç 1000 —Ç–æ–∫–µ–Ω–æ–≤:
  available = 8192 - 1000 - 500 = 6692
  dynamic_max = min(6692, 4096) = 4096 ‚úÖ

–ü—Ä–æ–º–ø—Ç 7000 —Ç–æ–∫–µ–Ω–æ–≤:
  available = 8192 - 7000 - 500 = 692
  dynamic_max = max(256, 692) = 692 ‚ö†Ô∏è
```

### qwen3:14b (context_window = 40960)

```
–ü—Ä–æ–º–ø—Ç 1000 —Ç–æ–∫–µ–Ω–æ–≤:
  available = 40960 - 1000 - 500 = 39460
  dynamic_max = min(39460, 4096) = 4096 ‚úÖ

–ü—Ä–æ–º–ø—Ç 30000 —Ç–æ–∫–µ–Ω–æ–≤:
  available = 40960 - 30000 - 500 = 10460
  dynamic_max = min(10460, 4096) = 4096 ‚úÖ –í—Å–µ –µ—â–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!
```

**–í—ã–≤–æ–¥:** –ú–æ–¥–µ–ª–∏ —Å –±–æ–ª—å—à–∏–º context_window –¥–∞—é—Ç –±–æ–ª—å—à–µ –≥–∏–±–∫–æ—Å—Ç–∏!

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞

```bash
# –¢–µ—Å—Ç 1: –ö–æ—Ä–æ—Ç–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
curl -X POST /summarize -d '{"doc_id":"short_doc"}'

# –í –ª–æ–≥–∞—Ö:
# [Summarization] Dynamic max_tokens: 1500 (requested: 500, available: 7000)
```

```bash
# –¢–µ—Å—Ç 2: –î–ª–∏–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
curl -X POST /summarize -d '{"doc_id":"long_doc"}'

# –í –ª–æ–≥–∞—Ö:
# [Summarization] Dynamic max_tokens: 800 (requested: 1500, available: 800)
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –¢–µ–ø–µ—Ä—å LLM_MAX_TOKENS - —ç—Ç–æ fallback!

```yaml
# docker-compose.yml
environment:
  - LLM_MAX_TOKENS=2048  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ default –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω —è–≤–Ω–æ
```

**–î–ª—è RAG:**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `LLM_MAX_TOKENS` (2048) –∫–∞–∫ –µ—Å—Ç—å

**–î–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏:**
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∏–Ω–∏–º—É–º –∏–∑ `desired` –∏ `available`

---

## üéØ –û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å

### –ú–æ–∂–Ω–æ –ª–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏?

**‚úÖ –î–ê! –ò —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ!**

**–§–æ—Ä–º—É–ª–∞:**
```python
available_for_output = context_window - prompt_tokens - safety_margin
actual_max_tokens = min(desired_max, available_for_output)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
1. ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ context_window
2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞
3. ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. ‚úÖ –ë–æ–ª—å—à–µ flexibility –¥–ª—è –º–æ–¥–µ–ª–µ–π —Å –±–æ–ª—å—à–∏–º –æ–∫–Ω–æ–º

**–°—Ç–æ–∏—Ç –ª–∏ —Å—Ç–∞–≤–∏—Ç—å LLM_MAX_TOKENS –±–æ–ª—å—à–µ 2048?**

**–û—Ç–≤–µ—Ç:** –¢–µ–ø–µ—Ä—å —ç—Ç–æ **–Ω–µ —Ç–∞–∫ –≤–∞–∂–Ω–æ**, –ø–æ—Ç–æ–º—É —á—Ç–æ:
- –î–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç
- `LLM_MAX_TOKENS` —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ fallback –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ RAG
- 2048 - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è fallback ‚úÖ

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

